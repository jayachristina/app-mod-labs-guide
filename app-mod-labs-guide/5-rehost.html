<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Rehost :: Application Modernization Labs Guide</title>
    <link rel="canonical" href="https://redhat-scholars.github.io/course-template/app-mod-labs-guide/5-rehost.html">
    <link rel="prev" href="4-refactor.html#deploy">
    <link rel="next" href="6-deploy-to-kubernetes.html#deploy">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-scholars.github.io/course-template">Application Modernization Labs Guide</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="app-mod-labs-guide" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="1-introduction.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="1-introduction.html">1. Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="2-assessment.html">2. Assessment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="3-analyze.html#package">3. Analyze</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="4-refactor.html#deploy">4. Refactor</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="#deploy">5. Rehost</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="6-deploy-to-kubernetes.html#deploy">5. Deploy to Kubernetes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="7-enhance-apps.html#deploy">7. Enhance apps</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="8-summary.html#deploy">8. Summary</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="1-introduction.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="1-introduction.html">Application Modernization Labs Guide</a></li>
    <li><a href="#deploy">5. Rehost</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/jayachristina/app-mod-labs-guide/edit/master/documentation/modules/ROOT/pages/5-rehost.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Rehost</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The steps you will follow to migrate the <strong>customers</strong> service from Red Hat Enterprise Virtualization (RHV) to Red Hat OpenShift are as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Migrate the <strong>Oracle VM</strong> from RHV to OpenShift Virtualization using the OpenShift Migration Toolkit for Virtualization</p>
</li>
<li>
<p>Modernize the Java source code for the <strong>customers</strong> application</p>
</li>
<li>
<p>Use the <a href="https://tekton.dev/" target="_blank" rel="noopener">Tekton</a> Pipeline to build and deploy the new, modernized application using Red Hat Web Server instead of Apache Tomcat as the runtime.</p>
</li>
<li>
<p>Set up the configuration for the <strong>customers</strong> service to connect to the Oracle database VM which is now running on OpenShift Container Platform</p>
</li>
<li>
<p>Test the <strong>customers</strong> service</p>
</li>
<li>
<p>Update the configuration for the <strong>gateway</strong> service to now point to the modernized <strong>customers</strong> service.</p>
</li>
<li>
<p>Demonstrate that your <strong>frontend</strong> service still works as before.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_migrate_the_oracle_vm_from_rhv_to_openshift"><a class="anchor" href="#_migrate_the_oracle_vm_from_rhv_to_openshift"></a>Migrate the Oracle VM from RHV to OpenShift</h3>
<div class="sect3">
<h4 id="_prerequisites"><a class="anchor" href="#_prerequisites"></a>Prerequisites</h4>
<div class="paragraph">
<p>Download the CA Certificate for your RHV environment. You need to do that on your laptop because you will need to drag the file into the Migration Toolkit for Virtualization (MTV) console later.</p>
</div>
<div class="paragraph">
<p>Set this variable to the RHV hostname from the e-mail.</p>
</div>
<div class="paragraph">
<p>Open a new browser to access the following URL. Make sure to replace <code>RHV_HOSTNAME`</code> with the hostname from your welcome e-mail (e.g., <strong>rhvm.dev.cnv.infra.opentlc.com</strong>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">https://&lt;RHV_HOSTNAME&gt;/ovirt-engine/services/pki-resource?resource=ca-certificate&amp;format=X509-PEM-CA</code></pre>
</div>
</div>
<div class="paragraph">
<p>On most systems this will download a file <code>pki-resource.cer</code> into your <code>Downloads</code> folder. Take a note where this file got downloaded to. You will need it a little bit later.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_set_up_virtualization_provider_in_mtv"><a class="anchor" href="#_set_up_virtualization_provider_in_mtv"></a>Set up Virtualization Provider in MTV</h3>
<div class="paragraph">
<p>Log into the OpenShift Web Console from the e-mail.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Username: <code>admin</code></p>
</li>
<li>
<p>Password: <code>r3dh4t1!</code></p>
</li>
</ul>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="../images/ocp-login.png" alt="ocp-login">
</div>
</div>
<div class="paragraph">
<p>Go to <code>Virtualization</code> on the left menu and click on <code>Virtual Machines</code>. From the <strong>Projects</strong> drop down select the <strong>retail</strong> project. There are no Virtual Machines yet.</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="../images/ocp-vm.png" alt="ocp-vm">
</div>
</div>
<div class="paragraph">
<p>Click <code>Launch Migration Tool</code> to launch the OpenShift Migration Toolkit for Virtualization.</p>
</div>
<div class="paragraph">
<p>Log in using your <strong>admin</strong> credentials.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Username: <code>admin</code></p>
</li>
<li>
<p>Password: <code>r3dh4t1!</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If this is the first time you are logging in, click on <code>Get started</code> button.</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="../images/mtv-get-started.png" alt="mtv-get-started">
</div>
</div>
<div class="paragraph">
<p>Click <code>Add provider</code> on the list of <strong>Providers</strong>.</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="../images/mtv-add-provider.png" alt="mtv-add-provider">
</div>
</div>
<div class="paragraph">
<p>Select <strong>Red Hat Virtualization</strong> from the list of providers. Fill in the information from your e-mail.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Name: <code>rhv</code></p>
</li>
<li>
<p>RHV Manager host name or IP address*: The hostname from your e-mail (e.g., <code>rhvm.dev.cnv.infra.opentlc.com</code>)</p>
</li>
<li>
<p>RHV Manager user name: the username from your e-mail. (e.g., <code>migrateuser-96trd@internal</code>)</p>
</li>
<li>
<p>RHV Manager passsword: the password from yoru e-mail. (e.g., <code>ThvA2Ioa6Q4G</code>)</p>
</li>
<li>
<p>CA Certificate: Drop the previously downloaded CA Certificate File</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Click <code>Add</code>.</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="../images/mtv-add-provider-detail.png" alt="mtv-add-provider-detail">
</div>
</div>
<div class="paragraph">
<p>MTV will validate your provider and after a few seconds the status should switch to <strong>Ready</strong>.</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="../images/mtv-add-provider-ready.png" alt="mtv-add-provider-ready">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_create_and_execute_migration_plan"><a class="anchor" href="#_create_and_execute_migration_plan"></a>Create and execute Migration Plan</h3>
<div class="paragraph">
<p>Go to <code>Migration Plans</code> in the Migration Toolkit for Virtualization console. Click <code>Create Plan</code>.</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="../images/mtv-create-plan.png" alt="mtv-create-plan">
</div>
</div>
<div class="paragraph">
<p>On the <strong>General settings</strong> page use the following parameters.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Plan name: <code>customers-database</code></p>
</li>
<li>
<p>Source provider: <code>rhv</code></p>
</li>
<li>
<p>Target provider: select <strong>host</strong> (the OpenShift cluster you are currently on)</p>
</li>
<li>
<p>Target namespace*: select <strong>retail</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Click <code>Next</code>.</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="../images/mtv-plan-general.png" alt="mtv-plan-general">
</div>
</div>
<div class="paragraph">
<p>Check <code>All datacenters</code> on the <strong>Filter by VM location</strong>. Click <code>Next</code>.</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="../images/mtv-plan-vm-loc.png" alt="mtv-plan-vm-loc">
</div>
</div>
<div class="paragraph">
<p>Select the Oracle VM (e.g. <em>oracle-96trd</em>) in your welcome e-mail on the <strong>Select VMs</strong> page. Click <code>Next</code>.</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="../images/mtv-select-vm.png" alt="mtv-select-vm">
</div>
</div>
<div class="paragraph">
<p>Click on <strong>Select a network mapping</strong> on the <strong>Network Mapping</strong> page. Then, Select <code>Create a network mapping</code>. Leave the defaults and click <code>Next</code>.</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="../images/mtv-select-nw.png" alt="mtv-select-nw">
</div>
</div>
<div class="paragraph">
<p>Click on <strong>Select a storage mapping</strong> on the <strong>Storage Mapping</strong> page. Select <code>Create a storage mapping</code>.</p>
</div>
<div class="paragraph">
<p>Change the <strong>Target Storage Class</strong> to <code>gp2-csi</code> and click <code>Next</code>.</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="../images/mtv-select-storage.png" alt="mtv-select-storage">
</div>
</div>
<div class="paragraph">
<p>Select <code>Cold migration</code> on the <strong>Migration type</strong> page. Click <code>Next</code>.</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="../images/mtv-select-cold.png" alt="mtv-select-cold">
</div>
</div>
<div class="paragraph">
<p>Click <code>Next</code> on the <strong>Hooks</strong> page.</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="../images/mtv-select-hook.png" alt="mtv-select-hook">
</div>
</div>
<div class="paragraph">
<p>Click <code>Finish</code> on the <strong>Review</strong> page.</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="../images/mtv-review.png" alt="mtv-review">
</div>
</div>
<div class="paragraph">
<p>Now your Migration Plan is ready to use. To execute the plan click on <code>Start</code> button in the <strong>customers-database</strong> migration plan.</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="../images/mtv-plan-ready.png" alt="mtv-plan-ready">
</div>
</div>
<div class="paragraph">
<p>Confirm by clicking the blue <code>Start</code> button in the popup window.</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="../images/mtv-plan-start.png" alt="mtv-plan-start">
</div>
</div>
<div class="paragraph">
<p>Because you are running a <strong>cold migration</strong> the VM in RHV gets shutdown first.</p>
</div>
<div class="paragraph">
<p>The migration will take about <em>15 - 25</em> minutes after which you will have a running Oracle database VM in your OpenShift cluster.</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="../images/mtv-plan-complete.png" alt="mtv-plan-complete">
</div>
</div>
<div class="paragraph">
<p>Once the migration succeeds you will find a VM called <code>oracle-xxxxx</code> in your retail namespace.</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="../images/mtv-plan-complete-ocp.png" alt="mtv-plan-complete-ocp">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_post_migration_tasks"><a class="anchor" href="#_post_migration_tasks"></a>Post Migration Tasks</h3>
<div class="paragraph">
<p>The VM is not yet reachable from other applications on the cluster. You will need to add a label to the VM and then create a service to be able to connect to the database on the VM.</p>
</div>
<div class="paragraph">
<p>Add a label to your VM&#8217;s template metadata and make sure to replace <code>{GUID}</code> with your GUID.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc patch vm oracle-{GUID} --type=merge --patch='{"spec": { "template": { "metadata": { "labels": { "app": "oracle-{GUID}"}}}}}' -n retail</code></pre>
</div>
</div>
<div class="paragraph">
<p>Restart the VM for the VM Pod to pick up the new label. Go back to the <code>VirtualMachines</code> menu in the OpenShift Web Console. Click on your VM.</p>
</div>
<div class="paragraph">
<p>From the <strong>Action</strong> drop down select <strong>Restart</strong> then confirm by clicking <strong>Restart</strong> in the pop up dialog.</p>
</div>
<div class="imageblock unresolved">
<div class="content">
<img src="../images/restart-vm.png" alt="restart-vm">
</div>
</div>
<div class="paragraph">
<p>Create service for the database vm:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc create service clusterip oracle-{GUID} --tcp=1521:1521 --tcp=2022:22 -n retail</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make sure your service has the endpoint for the Oracle VM pod as an Endpoint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc describe svc oracle-{GUID} -n retail</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Sample Output</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-texinfo hljs" data-lang="texinfo">Name:              oracle-96trd
Namespace:         retail
Labels:            app=oracle-96trd
Annotations:       &lt;none&gt;
Selector:          app=oracle-96trd
Type:              ClusterIP
IP Family Policy:  SingleStack
IP Families:       IPv4
IP:                172.30.99.143
IPs:               172.30.99.143
Port:              1521-1521  1521/TCP
TargetPort:        1521/TCP
Endpoints:         10.128.1.156:1521
Port:              2022-22  2022/TCP
TargetPort:        22/TCP
Endpoints:         10.128.1.156:22
Session Affinity:  None
Events:            &lt;none&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>➡️ Next section: <a href="./6-deploy-to-kubernetes.adoc">6 - Deploy to Kubernetes</a></p>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="4-refactor.html#deploy">4. Refactor</a></span>
  <span class="next"><a href="6-deploy-to-kubernetes.html#deploy">5. Deploy to Kubernetes</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
